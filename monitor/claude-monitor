#!/bin/bash
#
# claude-monitor - Launches Claude Code with the Monitor Dashboard
#
# Usage:
#   claude-monitor [command] [claude-code-args...]
#
# This script:
#   1. Starts the WebSocket server (dashboard backend)
#   2. Starts the monitor-agent.py (protocol enforcer)
#   3. Opens the dashboard (Electron app or browser fallback)
#   4. Launches Claude Code with monitoring enabled
#   5. Cleans up on exit
#

set -e

# Configuration
MONITOR_PORT="${CLAUDE_MONITOR_PORT:-3847}"
MONITOR_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_DIR="${HOME}/.claude/logs"
PID_DIR="${HOME}/.claude/pids"
ELECTRON_DIR="${MONITOR_DIR}/electron"
USE_BROWSER="${CLAUDE_MONITOR_BROWSER:-false}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Create directories
mkdir -p "${LOG_DIR}" "${PID_DIR}"

# Print banner
echo -e "${PURPLE}"
echo "╔═══════════════════════════════════════════════════════╗"
echo "║      Claude Code + Protocol Monitor + Enforcer        ║"
echo "╚═══════════════════════════════════════════════════════╝"
echo -e "${NC}"

# Function to check if server is running
server_running() {
    curl -s "http://localhost:${MONITOR_PORT}/api/logs" > /dev/null 2>&1
}

# Function to check if Electron is available
electron_available() {
    if [ -d "${ELECTRON_DIR}/node_modules/electron" ]; then
        return 0
    fi
    return 1
}

# Function to start the monitor server
start_server() {
    echo -e "${BLUE}▶${NC} Starting monitor server..."
    
    cd "${MONITOR_DIR}"
    
    # Install dependencies if needed
    if [ ! -d "node_modules" ]; then
        echo -e "${YELLOW}  Installing server dependencies...${NC}"
        npm install --silent
    fi
    
    # Start server in background
    nohup node server/index.js > "${LOG_DIR}/monitor-server.log" 2>&1 &
    echo $! > "${PID_DIR}/monitor-server.pid"
    
    # Wait for server to be ready
    for i in {1..10}; do
        if server_running; then
            echo -e "${GREEN}✓${NC} Monitor server started on port ${MONITOR_PORT}"
            return 0
        fi
        sleep 0.5
    done
    
    echo -e "${RED}✗${NC} Failed to start monitor server"
    return 1
}

# Function to start the monitor agent (enforcer)
start_monitor_agent() {
    echo -e "${BLUE}▶${NC} Starting monitor agent (protocol enforcer)..."
    
    cd "${MONITOR_DIR}"
    
    # Check if already running
    if [ -f "${PID_DIR}/monitor-agent.pid" ]; then
        pid=$(cat "${PID_DIR}/monitor-agent.pid")
        if kill -0 "$pid" 2>/dev/null; then
            echo -e "${GREEN}✓${NC} Monitor agent already running (PID: $pid)"
            return 0
        fi
    fi
    
    # Start monitor agent in background
    nohup python3 monitor-agent.py --watch > "${LOG_DIR}/monitor-agent.log" 2>&1 &
    echo $! > "${PID_DIR}/monitor-agent.pid"
    
    echo -e "${GREEN}✓${NC} Monitor agent started (protocol enforcement active)"
}

# Function to open the dashboard with Electron
open_electron() {
    echo -e "${BLUE}▶${NC} Opening Electron dashboard..."
    
    cd "${ELECTRON_DIR}"
    
    # Install Electron dependencies if needed
    if [ ! -d "node_modules" ]; then
        echo -e "${YELLOW}  Installing Electron dependencies...${NC}"
        npm install --silent
    fi
    
    # Check if already running
    if [ -f "${PID_DIR}/electron.pid" ]; then
        pid=$(cat "${PID_DIR}/electron.pid")
        if kill -0 "$pid" 2>/dev/null; then
            echo -e "${GREEN}✓${NC} Electron dashboard already running"
            return 0
        fi
    fi
    
    # Start Electron app
    nohup npm start > "${LOG_DIR}/electron.log" 2>&1 &
    echo $! > "${PID_DIR}/electron.pid"
    
    echo -e "${GREEN}✓${NC} Electron dashboard started"
}

# Function to open the dashboard in browser (fallback)
open_browser() {
    local url="http://localhost:${MONITOR_PORT}"
    
    echo -e "${BLUE}▶${NC} Opening browser dashboard..."
    
    # Detect OS and open browser
    case "$(uname -s)" in
        Darwin)
            # macOS - open in a popup window
            osascript -e "
                tell application \"Google Chrome\"
                    set newWindow to make new window
                    set bounds of newWindow to {100, 100, 1400, 900}
                    set URL of active tab of newWindow to \"${url}\"
                end tell
            " 2>/dev/null || \
            osascript -e "
                tell application \"Safari\"
                    make new document with properties {URL:\"${url}\"}
                end tell
            " 2>/dev/null || \
            open "${url}" 2>/dev/null
            ;;
        Linux)
            # Linux - try various browsers with window size
            if command -v google-chrome &> /dev/null; then
                google-chrome --new-window --window-size=1300,800 --window-position=100,100 "${url}" 2>/dev/null &
            elif command -v chromium-browser &> /dev/null; then
                chromium-browser --new-window --window-size=1300,800 --window-position=100,100 "${url}" 2>/dev/null &
            elif command -v firefox &> /dev/null; then
                firefox --new-window "${url}" 2>/dev/null &
            elif command -v xdg-open &> /dev/null; then
                xdg-open "${url}" 2>/dev/null &
            fi
            ;;
        MINGW*|MSYS*|CYGWIN*)
            # Windows
            start "${url}"
            ;;
    esac
    
    echo -e "${GREEN}✓${NC} Dashboard: ${CYAN}${url}${NC}"
}

# Function to open dashboard (Electron or browser)
open_dashboard() {
    if [ "$USE_BROWSER" = "true" ]; then
        open_browser
    elif electron_available; then
        open_electron
    else
        echo -e "${YELLOW}!${NC} Electron not installed, using browser"
        echo -e "  To install Electron: cd ${ELECTRON_DIR} && npm install"
        open_browser
    fi
}

# Function to stop all services
stop_all() {
    echo -e "${YELLOW}▶${NC} Stopping services..."
    
    if [ -f "${PID_DIR}/electron.pid" ]; then
        pid=$(cat "${PID_DIR}/electron.pid")
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid" 2>/dev/null
            echo -e "${GREEN}✓${NC} Electron dashboard stopped"
        fi
        rm -f "${PID_DIR}/electron.pid"
    fi
    
    if [ -f "${PID_DIR}/monitor-server.pid" ]; then
        pid=$(cat "${PID_DIR}/monitor-server.pid")
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid" 2>/dev/null
            echo -e "${GREEN}✓${NC} Monitor server stopped"
        fi
        rm -f "${PID_DIR}/monitor-server.pid"
    fi
    
    if [ -f "${PID_DIR}/monitor-agent.pid" ]; then
        pid=$(cat "${PID_DIR}/monitor-agent.pid")
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid" 2>/dev/null
            echo -e "${GREEN}✓${NC} Monitor agent stopped"
        fi
        rm -f "${PID_DIR}/monitor-agent.pid"
    fi
}

# Handle script arguments
case "${1:-}" in
    stop)
        stop_all
        exit 0
        ;;
    status)
        echo -e "${CYAN}Monitor Status:${NC}"
        echo ""
        if server_running; then
            echo -e "  Dashboard Server: ${GREEN}✓ Running${NC} on port ${MONITOR_PORT}"
        else
            echo -e "  Dashboard Server: ${RED}✗ Not running${NC}"
        fi
        
        if [ -f "${PID_DIR}/monitor-agent.pid" ]; then
            pid=$(cat "${PID_DIR}/monitor-agent.pid")
            if kill -0 "$pid" 2>/dev/null; then
                echo -e "  Monitor Agent:    ${GREEN}✓ Running${NC} (PID: $pid)"
            else
                echo -e "  Monitor Agent:    ${RED}✗ Not running${NC}"
            fi
        else
            echo -e "  Monitor Agent:    ${RED}✗ Not running${NC}"
        fi
        
        if [ -f "${PID_DIR}/electron.pid" ]; then
            pid=$(cat "${PID_DIR}/electron.pid")
            if kill -0 "$pid" 2>/dev/null; then
                echo -e "  Electron App:     ${GREEN}✓ Running${NC} (PID: $pid)"
            else
                echo -e "  Electron App:     ${RED}✗ Not running${NC}"
            fi
        else
            echo -e "  Electron App:     ${YELLOW}○ Not started${NC}"
        fi
        
        echo ""
        
        if electron_available; then
            echo -e "  Electron:         ${GREEN}✓ Installed${NC}"
        else
            echo -e "  Electron:         ${YELLOW}○ Not installed${NC} (using browser)"
        fi
        
        echo ""
        exit 0
        ;;
    restart)
        stop_all
        sleep 1
        start_server
        start_monitor_agent
        open_dashboard
        exit 0
        ;;
    dashboard)
        open_dashboard
        exit 0
        ;;
    browser)
        USE_BROWSER=true
        open_browser
        exit 0
        ;;
    install-electron)
        echo -e "${BLUE}▶${NC} Installing Electron..."
        cd "${ELECTRON_DIR}"
        npm install
        echo -e "${GREEN}✓${NC} Electron installed"
        exit 0
        ;;
    build)
        echo -e "${BLUE}▶${NC} Building Electron app..."
        cd "${ELECTRON_DIR}"
        npm run dist
        echo -e "${GREEN}✓${NC} Build complete. Check ${ELECTRON_DIR}/dist/"
        exit 0
        ;;
    help|--help|-h)
        echo "Usage: claude-monitor [command] [claude-args...]"
        echo ""
        echo "Commands:"
        echo "  (none)           Start monitor and launch Claude Code"
        echo "  stop             Stop all monitor services"
        echo "  status           Check monitor status"
        echo "  restart          Restart all monitor services"
        echo "  dashboard        Just open the dashboard"
        echo "  browser          Open dashboard in browser (not Electron)"
        echo "  install-electron Install Electron dependencies"
        echo "  build            Build standalone Electron app"
        echo "  help             Show this help"
        echo ""
        echo "Components:"
        echo "  • Dashboard Server - WebSocket server for real-time log streaming"
        echo "  • Monitor Agent    - Impartial enforcer that watches for violations"
        echo "  • Electron App     - Native window dashboard (or browser fallback)"
        echo ""
        echo "Environment variables:"
        echo "  CLAUDE_MONITOR_PORT    Dashboard port (default: 3847)"
        echo "  CLAUDE_MONITOR_BROWSER Force browser mode (default: false)"
        echo ""
        exit 0
        ;;
esac

# Main flow: Start services if needed, open dashboard, run claude

# 1. Start WebSocket server
if ! server_running; then
    start_server
else
    echo -e "${GREEN}✓${NC} Monitor server already running"
fi

# 2. Start Monitor Agent (enforcer)
start_monitor_agent

# 3. Open dashboard (Electron or browser)
open_dashboard

echo ""
echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${CYAN}Protocol Enforcement Active${NC}"
echo "  • Orchestrator required for complexity ≥3"
echo "  • Quality gates: laziness-check, honesty-check"  
echo "  • Monitor agent watching for violations"
echo "  • All activity logged to dashboard"
echo -e "${PURPLE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Set environment variables for Claude Code
export CLAUDE_MONITOR_URL="http://localhost:${MONITOR_PORT}/log"
export CLAUDE_MONITOR_PORT="${MONITOR_PORT}"
export CLAUDE_LOG_DIR="${LOG_DIR}"

# Launch Claude Code with remaining arguments
if [ $# -gt 0 ]; then
    exec claude "$@"
else
    exec claude
fi
